<dom-module id="animated-grid">
  <link rel="import" type="css" href="../colors.css">
  <style>
    :host {
      display: block;
      margin: 1em 0;

      min-width: 500px;
      overflow-x: auto;

      position: relative;
      top: 0;
      left: 0;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      @apply(--layout-wrap);
    }

    * {
      box-sizing: border-box;
    }

    paper-material {
      width: 400px;
      opacity: 1;
      margin: 1em;
      overflow: hidden;
      border-radius: 3px;
      cursor: pointer;

      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hide-result-card {
      width: 0;
      opacity: 0;
      transform: scale(0,0);
    }

    paper-material:hover {
      @apply(--shadow-elevation-8dp);
    }

    .color-box {
      height: 200px;
      padding: 2.5px;
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-wrap);
    }

    .summary-info {
      position: relative;
      color: #fff;
      height: 90px;
      margin: 2.5px 5px;
    }

    .summary-info {
      --paper-item: {
        @apply(--paper-font-title);
      };
      --paper-item-body-secondary: {
        @apply(--paper-font-body1);
        color: var(--light-primary-color);
      };
    }

    .summary-info iron-icon {
      position: absolute;
      right: 5px;
      top: 5px;
      width: 20px;
    }

    .summary-info--small {
      width: 121.33333px;
    }

    .summary-info--large {
      width: 383px;
    }

    .caption-box {
      padding: 1em 1.5em;
      width: 100%;
    }
  </style>
  <template>
    <template id="animated-grid-repeat" is="dom-repeat" items="[[data]]" index="index">
      <paper-material class$="[[_compututePaperClass(item.category)]]" elevation="1" on-click="_onClick">
        <div class$="[[_computeColorBoxClass(item.category)]]">
          <paper-item class$="[[_computeSummaryClass( 'small', item.category )]]">
            <paper-item-body two-line>
              <div>
                <span>[[arrayItem(analyzeSummary.*, index, 'infoValue')]]</span> %
              </div>
              <div secondary>{{__('Info')}}</div>
            </paper-item-body>
            <iron-icon icon="info"></iron-icon>
          </paper-item>
          <paper-item class$="[[_computeSummaryClass( 'small', item.category )]]">
            <paper-item-body two-line>
              <div>
                <span>[[arrayItem(analyzeSummary.*, index, 'warningValue')]]</span> %
              </div>
              <div secondary>{{__('Warning')}}</div>
            </paper-item-body>
            <iron-icon icon="warning"></iron-icon>
          </paper-item>
          <paper-item class$="[[_computeSummaryClass( 'small', item.category )]]">
            <paper-item-body two-line>
              <div>
                <span>[[arrayItem(analyzeSummary.*, index, 'errorValue')]]</span> %
              </div>
              <div secondary>{{__('Error')}}</div>
            </paper-item-body>
            <iron-icon icon="error"></iron-icon>
          </paper-item>
          <paper-item class$="[[_computeSummaryClass( 'large', item.category )]]">
            <paper-item-body two-line>
              <div>
                <span>[[arrayItem(analyzeSummary.*, index, 'fileCount')]]</span>
              </div>
              <div secondary>{{__('Analized files')}}</div>
            </paper-item-body>
            <iron-icon icon="description"></iron-icon>
          </paper-item>
        </div>
        <div class="caption-box">[[computeItemLanguage(item.name)]]</div>
      </paper-material>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'animated-grid',

    behaviors: [
      Polymer.NeonSharedElementAnimatableBehavior
    ],

    properties: {
      analyzeSummary: {
        type: Array,
        value: []
      },
      animationConfig: {
        type: Object,
        value: function() {
          return {
            'exit': [{
              name: 'ripple-animation',
              id: 'ripple',
              fromPage: this
            }, {
              name: 'hero-animation',
              id: 'hero',
              fromPage: this
            }]
          }
        }
      }
    },

    ready: function () {
      var that = this;
      this.$[ 'animated-grid-repeat' ].addEventListener( 'dom-change' , function( e ) {
        e.target.items.forEach( function( result, index ) {
          // Get the current card
          var card = that.querySelector( '.result-card-' + result.category );

          // Set the data in the card for the binding in the fullsize card
          result['color'] = app.categories[ result.category ].color.main
          card.data = result;

          that.set( 'analyzeSummary.' + index, that._getPieData( result, index ) );
        });
      });
    },

    _getPieData:function ( results, index ) {
      var that = this;

      // Set the init counters values
      var summary = {
        infoCount: 0,
        infoValue: 0,
        warningCount: 0,
        warningValue: 0,
        errorCount: 0,
        errorValue: 0,
        fileCount: 0
      };

      // Get the analyze synthese
      results.data.forEach( function( file ) {
        if ( file.errors.length > 0 ) {
          file.errors.forEach( function( error ) {
            if ( Array.isArray( error[ 0 ] ) ) {
              error.forEach( function( subError ) {
                summary[ subError.type + 'Count' ]++;
              });
            } else {
              summary[ error.type  + 'Count' ]++;
            }
          });
        }
      });

      summary.fileCount = app.currentPlugin[ results.name.en ].fileCount;

      var total = summary.infoCount + summary.warningCount + summary.errorCount;
      if ( total ) {
        summary.infoValue = Math.round( ( summary.infoCount / total ) * 10000 ) / 100;
        summary.warningValue = Math.round( ( summary.warningCount / total ) * 10000 ) / 100;
        summary.errorValue = Math.round( ( summary.errorCount / total ) * 10000 ) / 100;
      } else {
        // no error
      }

      return summary;
    },

    arrayItem: function(change, index, path) {
      return this.get(path, change.base[index]);
    },

    _onClick: function( e ) {
      var target = e.target;
      while ( target !== this && !target._templateInstance ) {
        target = target.parentNode;
      }

      // configure the page animation
      this.sharedElements = {
        'hero': target.querySelector('.color-box'),
        'fade-in-title': target.querySelector('.caption-box'),
        'ripple': target
      };
      this.animationConfig[ 'exit' ][ 0 ].gesture = {
        x: event.x || event.pageX,
        y: event.y || event.pageY
      };

      this.fire('tile-click', {
        tile: target,
        data: target.data
      });
    },

    _computeColorBoxClass: function ( category ) {
      return 'color-box ' + app.categories[ category ].color.main + '-500';
    },

    _compututePaperClass: function ( category ) {
      return 'result-card-' + category;
    },

    _computeSummaryClass:function ( size, category ) {
      return 'summary-info summary-info--' + size + ' ' + app.categories[ category ].color.main + '-400';
    },

    computeItemLanguage: function ( item ) {
      return app.computeItemLanguage( item );
    },

    __:function ( string ) {
      return app.__(string)
    }
  });
</script>
