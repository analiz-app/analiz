<dom-module id="folder-tree">
  <style>
    :host {
      display: block;
    }

    .children {
      box-sizing: border-box;
      padding-left: .5em;
      overflow: hidden;
      height: auto;
    }

    .children.close { height: 0; }

    paper-icon-item {
      cursor: pointer;
      color: var(--secondary-text-color);
      font-size: .9em;
      min-height: 40px;
    }

    paper-icon-item:hover {
      background-color: var(--primary-background-color);
    }

    .folder-selected, .folder-selected:hover {
      background-color: var(--accent-color);
    }

  </style>
  <template>
    <div id="tree"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'folder-tree',

    properties: {
      data: {
        type: Object,
        value: {
          path: "",
          name: ".",
          children: [],
        },
        notify: true,
        observer: '_valueChanged'
      },
      tree: {
        type: String,
        value: ''
      }
    },

    listeners: {
      'click': '_toggleItem'
    },

    _valueChanged: function ( e ) {
      this.tree = this.createNode(this.data, true);

      Polymer.dom(this.$.tree).innerHTML = '<div>' + this.tree + '</div>';
    },

    createNode: function (data, isFirst) {
      if (data.type == 'directory') {
        var icon = (!isFirst) ? 'chevron-right' : 'expand-more';
        var openClass = (!isFirst) ? 'close' : 'open';

        var html = '<paper-icon-item data-path="' +  data.path + '" class="';
        html += (isFirst) ? 'folder-selected' : '';

        if ( data.children.length > 0 && this.isParent(data.children) ) {
          html += ' togglable'
          html += '">';
          html += '<iron-icon id="' + data.name + '-icon" icon="' + icon + '" item-icon></iron-icon>';
        } else {
          html += '>';
          html += '<iron-icon icon="folder" item-icon></iron-icon>';

        }
        html += data.name;
        html +='</paper-icon-item>';

        html += '<div id="' + data.name + '-tree" class="children ' + openClass + '">';
        while ( data.children.length > 0 ) {
          html += this.createNode(data.children.shift(), false);
        }
        html += '</div>';

        return html;
      } else {
        return '';
      }
    },

    _toggleItem: function ( e ) {
      if (e.target.icon) {
        var target = e.target.parentNode.parentNode;
      } else {
        var target = e.target;
      }
      if ( !e.target.classList.contains('children') ) {
        var oldSelected = document.querySelector( '.folder-selected' );
        oldSelected.classList.remove( 'folder-selected' );
        if ( !target.classList.contains( 'folder-selected' ) ) {
          target.classList.toggle( 'folder-selected' );
        }
        if (target.classList.contains('togglable')) {
          Polymer.dom(document.getElementById(target.outerText + '-tree')).classList.toggle('close');
          if (document.getElementById(target.outerText + '-tree').classList.contains('close')) {
            Polymer.dom(document.getElementById(target.outerText + '-icon')).setAttribute('icon', 'chevron-right');
          } else {
            Polymer.dom(document.getElementById(target.outerText + '-icon')).setAttribute('icon', 'expand-more');
          }
        }
        this.fire( 'folder-click', target );
      }
    },

    isParent: function ( children ) {
      for ( var i = 0; i < children.length; i++ ) {
        if ( children[i].type == 'directory' ) {
          return true;
        }
      }
      return false;
    }

  });
</script>
